<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>News App</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="article-page">

<!-- „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº -->
<div class="hamburger" onclick="toggleSidebar()">‚ò∞</div>

<!-- „Çµ„Ç§„Éâ„É°„Éã„É•„Éº -->
<div class="sidebar" id="sidebar">
    <h3>„Éï„Ç£„Éº„ÉâÈÅ∏Êäû</h3>

    <form method="get" action="/">
        {% for f in feeds_list %}
            <div>
                <label>
                    <input type="checkbox" name="feed" value="{{ f.id }}"
                        {% if feeds and f.id in feeds %}checked{% endif %}>
                    {{ f.name }}
                </label>
            </div>
        {% endfor %}
        <button type="submit" class="apply-btn">ÈÅ©Áî®</button>
    </form>
</div>

<div class="container">

    <h1 class="my-4">Ë®ò‰∫ã‰∏ÄË¶ß</h1>

    <div class="toolbar">
    
        <!-- „Éá„Éº„ÇøÊõ¥Êñ∞ -->
        <form action="/feeds/fetch" method="post" class="mb-0">
            <button type="submit" class="btn btn-primary">„Éá„Éº„ÇøÊõ¥Êñ∞</button>
        </form>
    
        <!-- „Ç≠„Éº„ÉØ„Éº„ÉâÊ§úÁ¥¢ -->
        <form action="/" method="get" class="mb-0 d-flex align-items-center gap-2">
            <input type="text" name="q" placeholder="„Ç≠„Éº„ÉØ„Éº„Éâ"
                   class="form-control" style="max-width: 200px;" value="{{ q }}">
            <input type="hidden" name="sort" value="{{ sort }}">
            {% for f in feeds %}
                <input type="hidden" name="feed" value="{{ f }}">
            {% endfor %}
            <button type="submit" class="btn btn-secondary">Ê§úÁ¥¢</button>
        </form>
    
        <!-- ‰∏¶„Å≥È†Ü -->
        <form action="/" method="get" class="mb-0">
            <input type="hidden" name="q" value="{{ q }}">
            {% for f in feeds %}
                <input type="hidden" name="feed" value="{{ f }}">
            {% endfor %}
            <select name="sort"
                    class="form-select"
                    style="width: 140px; display: inline-block;"
                    onchange="this.form.submit()">
                <option value="new"        {% if sort=='new' %}selected{% endif %}>Êñ∞„Åó„ÅÑÈ†Ü</option>
                <option value="old"        {% if sort=='old' %}selected{% endif %}>Âè§„ÅÑÈ†Ü</option>
                <option value="title_asc"  {% if sort=='title_asc' %}selected{% endif %}>„Çø„Ç§„Éà„É´ÊòáÈ†Ü</option>
                <option value="title_desc" {% if sort=='title_desc' %}selected{% endif %}>„Çø„Ç§„Éà„É´ÈôçÈ†Ü</option>
            </select>
        </form>
    
        <!-- „ÅäÊ∞ó„Å´ÂÖ•„Çä„Éï„Ç£„É´„Çø -->
        <div class="mb-0">
            {% if fav %}
                <a href="/?sort={{ sort }}&q={{ q }}"
                   class="btn btn-warning">
                    ‚≠ê „ÅäÊ∞ó„Å´ÂÖ•„ÇäËß£Èô§
                </a>
            {% else %}
                <a href="/?fav=1&sort={{ sort }}&q={{ q }}"
                   class="btn btn-warning">
                    ‚≠ê „ÅäÊ∞ó„Å´ÂÖ•„Çä„Å†„Åë
                </a>
            {% endif %}
        </div>
    
    </div>


    <!-- Ë®ò‰∫ã„ÉÜ„Éº„Éñ„É´ -->
    <table class="article-table">
        <thead>
            <tr>
                <th class="title-col">„Çø„Ç§„Éà„É´</th>
                <th class="desc-col">Ë™¨Êòé</th>
                <th class="date-col">Êó•‰ªò</th>
            </tr>
        </thead>

        <tbody>
            {% for a in articles %}
                <tr class="clickable-row {{ 'read' if a.is_read else '' }}"
                    data-article-id="{{ a.id }}"
                    onclick="openArticleAndMarkRead(this, '{{ a.link }}', {{ a.id }})">


                <td class="title-cell" title="{{ a.title | e }}">
                    <div class="title-row">

                    <!-- „ÅäÊ∞ó„Å´ÂÖ•„Çä„Éú„Çø„É≥ÔºàJS„Åß„Éà„Ç∞„É´Ôºâ -->
                    <button class="favorite-btn"
                        onclick="toggleFavorite(event, {{ a.id }}, this)">
                        {% if a.is_favorite %}
                                ‚≠ê
                        {% else %}
                                ‚òÜ
                        {% endif %}
                    </button>

                        <span class="title-text">üîó{{ a.title }}</span>
                        <span class="feed-label">[{{ a.feed_name }}]</span>
                    </div>
                </td>

                <td class="desc-cell">
                    <div class="desc-text" title="{{ a.description | e }}">
                        {{ a.description | safe}}
                    </div>
                </td>

                <td class="date-cell">{{ a.published_at | format_date }}</td>

            </tr>
            {% endfor %}
        </tbody>
    </table>

</div>

<script>
function toggleSidebar() {
    document.getElementById("sidebar").classList.toggle("open");
}

function toggleFavorite(event, articleId, buttonEl) {
    // Ë°å„ÇØ„É™„ÉÉ„ÇØ„ÇíÊ≠¢„ÇÅ„Çã
    event.stopPropagation();
    event.preventDefault();

    fetch(`/favorite/${articleId}`, {
        method: "POST"
    })
    .then(res => res.json())
    .then(data => {
        // API „Åã„Çâ { success: true, favorite: 0/1 } „ÅåËøî„Å£„Å¶„Åè„ÇãÂâçÊèê
        if (data.favorite === 1) {
            buttonEl.textContent = "‚≠ê";
        } else {
            buttonEl.textContent = "‚òÜ";
        }
    })
    .catch(err => {
        console.error("toggleFavorite error:", err);
    });
}
</script>

</body>
</html>

<script>
async function toggleFavorite(event, articleId, buttonEl) {
    event.stopPropagation();
    event.preventDefault();

    const res = await fetch(`/favorite/${articleId}`, { method: "POST" });
    const data = await res.json();

    buttonEl.textContent = data.favorite ? "‚≠ê" : "‚òÜ";
}

function openArticleAndMarkRead(row, url, articleId) {
    window.open(url, '_blank');

    fetch(`/read/${articleId}`, {
        method: "POST",
        headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            row.classList.add("read");
        }
    });
}

</script>
